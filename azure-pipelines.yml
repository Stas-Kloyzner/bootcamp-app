# Starter pipeline
- task: CmdLine@2
  inputs:
    script: 'env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USER --hp /home/$USER'
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  name: w7pool

stages:
- stage: Build
  displayName: Build stage
  
  jobs:
  - job: Build
    displayName: Build

    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '14.x'
      displayName: 'Install Node.js'
    
    - task: Npm@1
      inputs:
        command: custom
        customCommand: 'install -g npm@latest'
      displayName: 'Upgrade npm to latest version'

    - task: Npm@1
      inputs:
        command: install
      displayName: 'npm install packages'

    - task: Npm@1
      inputs:
        command: custom
        customCommand: 'install pm2@latest -g'
      displayName: 'install pm2'

- task: CmdLine@2
  inputs:
    script: 'env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USER --hp /home/$USER'
  displayName: configure pm2 startup in systemd
  # - job: archive
  #   displayName: zip archive

  #   steps:
  #   - task: ArchiveFiles@2
  #     inputs:
  #       rootFolderOrFile: '$(Build.BinariesDirectory)'
  #       includeRootFolder: true
  #       archiveType: 'zip'
  #       archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
  #       replaceExistingArchive: true
  #       verbose: true
  
  # - job: publish
  #   displayName: publish artifact
    
  #   steps:
  #   - task: PublishBuildArtifacts@1
  #     inputs:
  #       PathtoPublish: '$(Build.ArtifactStagingDirectory)'
  #       ArtifactName: 'drop'
  #       publishLocation: 'Container'
    

